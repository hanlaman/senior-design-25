services:
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    platform: linux/amd64
    container_name: remind-api-mssql
    restart: unless-stopped
    environment:
      ACCEPT_EULA: 'Y'
      MSSQL_SA_PASSWORD: 'Remind_Password123!'
      MSSQL_PID: 'Developer'
    ports:
      - '1433:1433'
    volumes:
      - mssql_data:/var/opt/mssql
      - ./docker/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    healthcheck:
      test:
        [
          'CMD-SHELL',
          "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'Remind_Password123!' -C -Q 'SELECT 1' || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  mssql-init:
    image: mcr.microsoft.com/mssql/server:2022-latest
    platform: linux/amd64
    container_name: remind-api-mssql-init
    depends_on:
      mssql:
        condition: service_healthy
    volumes:
      - ./docker/init-db.sql:/init-db.sql:ro
    entrypoint:
      - /bin/bash
      - -c
      - |
        /opt/mssql-tools18/bin/sqlcmd -S mssql -U sa -P 'Remind_Password123!' -C -i /init-db.sql
        echo "Database initialized successfully"
    restart: 'no'

volumes:
  mssql_data:
